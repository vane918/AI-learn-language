# LexiMemo AI 划词翻译功能使用说明

## 实现说明

### 🚀 核心功能
- ✅ **智能划词翻译**: 鼠标划词自动弹出翻译卡片（无需右键点击）
- ✅ **多 AI 模型支持**: OpenAI、DeepSeek、Google Gemini、Qwen（通义千问）
- ✅ **流式翻译**: 实时显示翻译结果，提升响应速度
- ✅ **智能记忆系统**: 基于艾宾浩斯记忆曲线的 SM-2 算法
- ✅ **云端同步**: Firebase 自动同步学习数据
- ✅ **离线支持**: 本地优先模式，无网络也能使用
- ✅ **美观 UI**: Material-UI 设计，现代化界面
- ✅ **语音朗读**: TTS 语音播放功能
- ✅ **智能上下文**: 自动获取上下文信息提升翻译质量

### 🏗️ 技术架构
- **Manifest V3**: 使用最新的 Chrome 扩展规范
- **React 18 + TypeScript**: 现代化前端技术栈
- **Content Script**: 负责页面文本选择检测和翻译卡片显示
- **Service Worker**: 处理 AI 翻译请求和数据存储
- **Firebase**: 用户认证和云端数据同步
- **Zustand + TanStack Query**: 状态管理和数据缓存
- **Material-UI**: 现代化 UI 组件库
- **Vite**: 快速构建工具

### 🔄 数据流程
1. **文本选择** → Content Script 检测
2. **翻译请求** → Service Worker 处理
3. **AI 调用** → 支持流式响应
4. **结果显示** → 实时更新翻译卡片
5. **数据保存** → 本地存储 + 云端同步

### 最近修复的问题

#### 1. ES6 模块导入问题（已解决）
**问题**: Content script 中使用了 ES6 模块导入语法，导致浏览器报错
**解决方案**: 
- 将 `messageService.ts` 中的核心功能直接内联到 `src/content/index.ts` 中
- 移除了 ES6 模块导入语句，确保 `dist/content.js` 不再包含模块导入语法
**影响**: 
- ✅ `content.js` 已无模块导入语法
- ✅ `vite.config.ts` 使用 ES 模块格式
- ✅ `background.js` 和 `popup.js` 正确使用 ES 模块（manifest.json 中配置了 `"type": "module"`）

#### 2. 划词翻译触发优化（最新修复）
**问题**: 用户反馈划词后需要右键点击才能呼出翻译
**解决方案**:
- 移除了 300ms 的延迟触发机制
- 优化事件处理逻辑，确保 `mouseup` 事件后立即显示翻译卡片
- 改进了鼠标位置获取，确保翻译卡片正确定位
**影响**:
- ✅ 现在划词后立即显示翻译卡片，无需额外操作
- ✅ 提升了用户体验，响应更加迅速

#### 3. 翻译卡片排版优化（✨ 最新更新）
**问题**: 翻译结果显示不够清晰，解释和例句混在一起
**解决方案**:
- ✅ **翻译内容**：主要翻译结果以较大字体显示
- ✅ **解释内容**：另起一行显示，带有"解释："标签
- ✅ **解释分点**：支持多种分隔符（换行符、分号、句号等）自动分行
- ✅ **例句显示**：独立区域显示例句，每个例句单独一行
- ✅ **音标显示**：支持 `phonetic` 和 `pronunciation` 字段
- ✅ **美观样式**：不同内容区域有不同的字体大小和颜色
**影响**:
- ✅ 翻译卡片排版更加清晰，信息层次分明
- ✅ 解释内容自动分行，阅读体验大幅提升
- ✅ 例句独立显示，便于学习和理解

## 📖 使用步骤

### 1. 🔑 配置 AI 服务
1. 点击浏览器工具栏中的扩展图标
2. 进入"设置"页面
3. 选择 AI 提供商：
   - **OpenAI**: GPT-3.5/GPT-4 模型
   - **DeepSeek**: 高性价比的国产 AI
   - **Google Gemini**: Google 的多模态 AI
   - **Qwen（通义千问）**: 阿里巴巴的大语言模型
4. 输入对应的 API Key
5. 点击"验证"确保 API Key 有效
6. 保存设置

### 2. 🎯 使用划词翻译
1. 在任何网页上选中要翻译的文本
2. 翻译卡片会立即自动弹出
3. 享受流式翻译体验：
   - 翻译结果实时显示
   - 无需等待完整响应
   - 提升使用体验

### 3. 📚 查看翻译结果
翻译卡片包含丰富信息：
- **原文显示**: 选中的文本内容
- **翻译内容**: 主要翻译结果（较大字体）
- **音标信息**: 发音指导（如果有）
- **详细解释**: 分行显示，层次清晰
- **例句展示**: 独立区域，便于学习

### 4. ⚡ 操作功能
- **📚 保存到学习本**: 自动添加到复习系统
- **🔊 语音朗读**: TTS 播放原文发音
- **📊 学习统计**: 查看学习进度和数据
- **☁️ 云端同步**: 自动同步到 Firebase
- **🔄 复习提醒**: 基于记忆曲线的智能提醒
- **⚙️ 快速设置**: 一键跳转到配置页面
- **❌ 关闭卡片**: 点击关闭或按 ESC 键

## 🔧 问题诊断与解决

### 如果划词翻译不工作：

1. **🔍 检查扩展状态**
   - 打开浏览器开发者工具 (F12)
   - 查看 Console 是否有 "LexiMemo AI: Content script loaded" 消息
   - 确认扩展图标在工具栏中显示

2. **🔑 检查 AI 服务配置**
   - 选中文本后如果显示 "⚠️ 请先配置 AI 服务"
   - 点击"配置 API Key"按钮或手动打开扩展设置
   - 验证 API Key 是否有效且有足够余额

3. **🌐 检查网络连接**
   - 确保网络连接正常
   - 检查防火墙是否阻止扩展访问
   - 验证 AI 服务提供商的服务状态

4. **🐛 检查控制台错误**
   - 打开开发者工具查看是否有 JavaScript 错误
   - ✅ **已修复**: ES6 模块导入错误
   - ✅ **已修复**: Service Worker 通信问题

5. **☁️ 检查云端同步**
   - 确认 Firebase 连接状态
   - 检查是否已完成匿名登录
   - 验证数据同步是否正常

## 🛠️ 调试方法

### 开发者工具调试
```javascript
// 测试翻译功能
chrome.runtime.sendMessage({
  action: 'translate',
  data: { 
    text: 'hello world', 
    context: 'greeting',
    provider: 'openai' // 或 'deepseek', 'gemini', 'qwen'
  }
}, (response) => {
  console.log('Translation result:', response);
});

// 测试流式翻译
chrome.runtime.sendMessage({
  action: 'streamTranslate',
  data: { text: 'hello', context: 'greeting' }
});

// 检查存储状态
chrome.storage.local.get(null, (data) => {
  console.log('Local storage:', data);
});
```

### 检查扩展状态
1. 访问 `chrome://extensions/`
2. 确保 LexiMemo AI 扩展已启用
3. 检查是否有错误信息
4. 点击"重新加载"刷新扩展
5. 查看"检查视图"中的错误日志

### Firebase 连接测试
```javascript
// 在扩展 popup 中测试
chrome.runtime.sendMessage({
  action: 'checkFirebaseConnection'
}, (response) => {
  console.log('Firebase status:', response);
});
```

## 🚀 功能优化与发展规划

### ✅ 已完成功能
1. **🎯 核心翻译**
   - 多 AI 模型支持（OpenAI、DeepSeek、Gemini、Qwen）
   - 流式翻译实时响应
   - 智能上下文分析

2. **🧠 记忆系统**
   - SM-2 算法复习调度
   - 学习进度跟踪
   - 难度评级系统

3. **☁️ 数据同步**
   - Firebase 云端存储
   - 匿名用户认证
   - 本地优先模式
   - 离线支持

4. **🎨 用户体验**
   - Material-UI 现代界面
   - 响应式设计
   - 流畅动画效果

### 🔄 正在优化
1. **⚡ 性能提升**
   - 翻译结果缓存机制
   - 内存使用优化
   - 网络请求优化

2. **🛡️ 错误处理**
   - 网络异常处理
   - API 限流处理
   - 用户友好的错误提示

3. **📊 用户体验**
   - 学习统计可视化
   - 个性化设置选项
   - 快捷键支持

### 📋 计划功能

#### 🎯 下一版本 (v1.1.0)
- [ ] **🔊 发音功能**: 完善 TTS 语音播放
- [ ] **📤 导入导出**: 学习数据备份和迁移
- [ ] **🎨 主题定制**: 多种界面主题选择
- [ ] **📈 统计图表**: 详细的学习数据分析

#### 🌟 未来版本
- [ ] **🌍 多语言界面**: 支持多种界面语言
- [ ] **👥 社交功能**: 学习分享和排行榜
- [ ] **📱 移动适配**: PWA 移动端支持
- [ ] **🤖 更多 AI**: 集成更多 AI 模型
- [ ] **🎯 智能推荐**: 个性化学习内容推荐

## 🎨 UI 设计特色

### 翻译卡片设计 ✨
- **🎨 现代化外观**: 圆角、阴影、渐变背景
- **📱 响应式布局**: 适配不同屏幕尺寸
- **🎬 动画效果**: 平滑的出现和消失动画
- **♿ 可访问性**: 支持键盘导航和屏幕阅读器
- **📖 优化排版**: 清晰的信息层次，解释和例句分行显示

### 样式特点
- **📏 尺寸**: 最大宽度 350px，最小宽度 280px
- **🎨 背景**: 白色半透明，带毛玻璃效果
- **🔤 字体**: 系统默认字体栈，确保跨平台兼容性
- **🌈 配色**: 蓝紫色渐变主题，符合 Material Design

### 排版结构 ✨
```
┌─────────────────────────────┐
│ 📝 原文                     │
├─────────────────────────────┤
│ 🎯 翻译结果 (较大字体)       │
│ 🔊 [音标]                   │
│                             │
│ 💡 解释：第一个解释点        │
│ • 第二个解释点               │
│ • 第三个解释点               │
│                             │
│ 📚 例句：                   │
│ • 例句1                     │
│ • 例句2                     │
├─────────────────────────────┤
│ [💾 保存] [🔊 朗读] [⚙️ 设置] │
└─────────────────────────────┘
```

## 📁 相关文件

### 🔧 核心文件
- `src/content/index.ts` - 划词翻译主逻辑 ✅ **已修复模块导入** ✅ **支持流式翻译**
- `src/background/index.ts` - Service Worker 消息处理
- `src/services/aiService.ts` - AI 翻译服务适配器
- `src/services/firebaseService.ts` - Firebase 云端同步服务
- `src/services/storageService.ts` - 本地数据存储服务
- `src/stores/` - Zustand 状态管理
- `dist/content.js` - 构建后的 content script ✅ **无模块导入语法**

### ⚙️ 配置文件
- `manifest.json` - Chrome 扩展清单文件 (Manifest V3)
- `vite.config.ts` - 构建配置 ✅ **使用 ES 模块格式**
- `tsconfig.json` - TypeScript 配置
- `package.json` - 项目依赖管理

### 🎨 样式文件
- `src/content/styles.css` - Content script 样式
- `src/popup/` - Popup 界面组件和样式
- `dist/` - 构建输出目录

### 📚 文档文件
- `README.md` - 项目主要文档
- `TECHNICAL.md` - 技术架构文档
- `CHANGELOG.md` - 版本更新日志
- `project_rules.md` - 项目开发规范

### 🧪 测试文件
- `test.html` - 功能测试页面
- `test-*.html` - 各种功能测试页面

---

## 📊 项目状态

**当前版本**: v1.0.0  
**开发状态**: ✅ **功能完整，持续优化中**  
**技术栈**: React 18 + TypeScript + Vite + Material-UI + Firebase  
**支持 AI**: OpenAI, DeepSeek, Google Gemini, Qwen（通义千问）  
**核心功能**: ✅ 划词翻译 ✅ 流式响应 ✅ 智能记忆 ✅ 云端同步  

### 🎯 关键特性
- ✅ **Manifest V3**: 使用最新 Chrome 扩展标准
- ✅ **流式翻译**: 实时显示翻译结果
- ✅ **多 AI 支持**: 四种主流 AI 模型
- ✅ **智能记忆**: SM-2 算法复习系统
- ✅ **云端同步**: Firebase 自动数据同步
- ✅ **离线支持**: 本地优先数据存储
- ✅ **现代 UI**: Material-UI 响应式设计

### 🔄 持续改进
- 🔄 性能优化和错误处理
- 🔄 用户体验提升
- 🔄 功能扩展和完善

---

**最后更新**: 2024年12月19日  
**维护状态**: 🟢 **活跃开发中**